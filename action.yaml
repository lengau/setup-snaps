name: Setup Snaps
description: |
  Download and install one or more snaps from the snap store, with caching.

inputs:
  snaps:
    description: |
      A multi-line string of snaps to install. The format is as follows:

        snap-name [ --channel=channel ]

runs:
  using: composite
  steps:
    - name: Check OS and install snap if necessary
      shell: bash
      run: |
        if [[ '${{ runner.os }}' != 'Linux' ]]; then
          echo -e "\e[31mERROR\e[0m: This action only works on Linux runners" >> /dev/stderr
          echo "# Tried to get snaps on non-Linux runner" >> "${GITHUB_STEP_SUMMARY}"
          exit 1
        fi

        if ! command -v snap || ! command -v xdelta3; then
          if command -v apt-get; then
            if ! sudo apt-get --yes install snapd xdelta3; then
              sudo apt-get update
              sudo apt-get --yes install snapd xdelta3
            fi
          else
            echo -e "\e[31mERROR\e[0m: needed command unavailable and unknown Linux distribution" >> /dev/stderr
          fi
        fi
    - name: Get cached snaps
      uses: actions/cache/restore@v4
      id: restore
      with:
        path: ${{ runner.temp }}/.snap_cache
        key: snap-cache-${{ runner.arch }}-${{ github.workflow }}-${{ github.job }}-${{ github.ref }}-${{ github.sha }}
        restore-keys: |
          snap-cache-${{ runner.arch }}-${{ github.workflow }}-${{ github.job }}-${{ github.ref }}-
          snap-cache-${{ runner.arch }}-${{ github.workflow }}-${{ github.job }}-
          snap-cache-${{ runner.arch }}-${{ github.workflow }}-
          snap-cache-${{ runner.arch }}-
    - name: Refresh cache
      shell: bash
      run: |
        mapfile snaps -t <<EOF
        ${{ inputs.snaps }}EOF

        mkdir -p "${{ runner.temp }}/.snap_cache"
        cd "${{ runner.temp }}/.snap_cache"
        mkdir old_snaps
        mv *.snap *.assert old_snaps || true

        for snap_line in "${snaps[@]}"; do
          name=$(echo "${snap_line}" | awk '{print $1;}')
          mv "old_snaps/${name}_*" . || true
          old_snaps="$(find . -type f -regextype egrep -regex ".*/${name}_[0-9]+\.(snap|assert)")"
          snap download ${snap_line}
          current_snaps="$(find . -type f -regextype egrep -regex ".*/${name}_[0-9]+\.(snap|assert)")"
          if [[ $(echo "${current_snaps}" | wc -l) > $(echo "${old_snaps}" | wc -l) ]]; then
            if [[ $(echo "${old_snaps}" | wc -l) > 1 ]]; then
              rm $old_snaps
            fi
          fi
        done

        rm -rf old_snaps
    - name: Install snaps
      shell: bash
      run: |
        cd "${{ runner.temp }}/.snap_cache"
        find . -type f -name '*.assert' -exec sudo snap ack '{}' ';'
        find . -type f -name '*.snap' -exec sudo snap install --classic '{}' '+'
    - name: Save cached snaps
      uses: actions/cache/save@v4
      with:
        path: ${{ runner.temp }}/.snap_cache
        key: ${{ steps.restore.outputs.cache-primary-key }}
